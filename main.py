from funcs import *
import numpy as np
import matplotlib.pyplot as plt

hn_path = './hn.csv'
wav_path = './fetal_heart_filtered.wav'
fs = 44100.

# Import filter h[n] generated by MATLAB
hn_arr = parse_hn(hn_path)

# Import audio data
audio_data = input_audio(wav_path)

# Calculate length of audio file
total_time = np.size(audio_data) / fs

# Bandpass filter data
filtered_data = filter_data(audio_data, hn_arr)

# Calculate short time fourier transform
s = do_stft(filtered_data, fs)
# Calculate signal power vs time
sig_power = stft2sigpower(s)

# Determine number of peaks in signal power
peaks, peaks_idx = findpeaks(sig_power)

# Calculate frequency
num_peaks = np.size(peaks)
freq = num_peaks / total_time
print("Heart rate: %0.1f bpm" % (freq*60))

# Plot stuff
fig = plt.figure()
ax1 = fig.add_subplot(111)
ax1.plot(sig_power)
ax1.scatter(peaks_idx, peaks)
plt.title('Signal Power vs. Time')
plt.ylabel('Signal Power')
plt.xlabel('Time [sec]')
plt.show()

